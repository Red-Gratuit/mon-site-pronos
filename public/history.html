<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Historique des Pronostics - E&V Prono</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
:root{
  --gold:#f0a500;--dark:#080b12;--card:#0e1220;--card2:#131826;
  --border:#1e2538;--text:#e8eaf0;--muted:#5a6380;
  --green:#00c97a;--red:#ff4757;--blue:#4f8ef7;--purple:#8b5cf6;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px;}

/* NAVBAR */
nav{display:flex;justify-content:space-between;align-items:center;padding:0 40px;height:64px;background:rgba(8,11,18,0.97);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);position:sticky;top:0;z-index:200;}
.logo{display:flex;align-items:center;gap:10px;font-size:1.25rem;font-weight:800;letter-spacing:-0.5px;text-decoration:none;color:var(--text);}
.logo-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#ff8c00);display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.logo span{color:var(--gold);}
.nav-center{display:flex;gap:5px;}
.nav-link{padding:8px 16px;border-radius:8px;color:var(--muted);font-size:0.88rem;font-weight:500;cursor:pointer;transition:all 0.2s;border:none;background:none;text-decoration:none;color:var(--muted);}
.nav-link:hover,.nav-link.active{color:var(--text);background:var(--card2);}
.nav-right{display:flex;align-items:center;gap:10px;}
.nav-username{font-size:0.85rem;font-weight:600;color:var(--gold);background:rgba(240,165,0,0.1);padding:5px 12px;border-radius:20px;cursor:pointer;transition:all 0.2s;}
.nav-username:hover{background:rgba(240,165,0,0.2);transform:translateY(-1px);}
.btn{padding:8px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.2s;}
.btn-google{background:#fff;color:#1a1a2e;display:flex;align-items:center;gap:7px;}
.btn-google:hover{background:#f0f0f0;transform:translateY(-1px);}
.btn-vip{background:linear-gradient(135deg,var(--gold),#ff8c00);color:#000;font-weight:700;box-shadow:0 4px 15px rgba(240,165,0,0.3);}
.btn-vip:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(240,165,0,0.4);}
.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-outline:hover{border-color:var(--gold);color:var(--gold);}
.btn-logout{background:rgba(255,71,87,0.1);color:var(--red);border:1px solid rgba(255,71,87,0.2);}
.btn-logout:hover{background:rgba(255,71,87,0.2);}

/* CONTAINER */
.container{max-width:1200px;margin:0 auto;padding:40px 20px;}
.section-header{text-align:center;margin-bottom:40px;}
.section-header h2{font-size:2.5rem;font-weight:900;color:var(--text);margin-bottom:10px;}
.section-header p{color:var(--muted);font-size:1.1rem;}

/* HISTORIQUE STYLES */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;align-items:center;gap:15px;transition:all 0.3s;}
.stat-card:hover{transform:translateY(-2px);border-color:var(--gold);}
.stat-icon{font-size:2rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:rgba(240,165,0,0.1);border-radius:10px;}
.stat-info{flex:1;}
.stat-value{font-size:1.5rem;font-weight:800;color:var(--text);}
.stat-label{font-size:0.85rem;color:var(--muted);margin-top:2px;}

.filters-section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin:30px 0;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;align-items:end;}
.filter-group{display:flex;flex-direction:column;}
.filter-group label{font-size:0.85rem;color:var(--muted);margin-bottom:5px;font-weight:500;}
.filter-group select,.filter-group input{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--dark);color:var(--text);font-size:0.85rem;}

.pronos-history{margin:30px 0;}
.history-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:15px;transition:all 0.3s;}
.history-card:hover{transform:translateY(-2px);border-color:var(--gold);}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.history-match{font-size:1.1rem;font-weight:700;color:var(--text);}
.history-league{font-size:0.85rem;color:var(--muted);background:var(--dark);padding:4px 8px;border-radius:6px;}
.history-prono{font-size:1rem;color:var(--text);margin-bottom:10px;}
.history-details{display:flex;gap:15px;align-items:center;font-size:0.85rem;color:var(--muted);}
.history-odds{font-weight:700;color:var(--gold);}
.history-date{color:var(--muted);}
.history-result{padding:4px 12px;border-radius:20px;font-weight:600;font-size:0.8rem;}
.result-gagnant{background:rgba(0,201,122,0.1);color:var(--green);border:1px solid rgba(0,201,122,0.2);}
.result-perdant{background:rgba(255,71,87,0.1);color:var(--red);border:1px solid rgba(255,71,87,0.2);}
.result-pending{background:rgba(240,165,0,0.1);color:var(--gold);border:1px solid rgba(240,165,0,0.2);}

.pagination{display:flex;justify-content:center;align-items:center;gap:20px;margin:30px 0;}
.pagination button{padding:10px 20px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:all 0.2s;}
.pagination button:hover:not(:disabled){border-color:var(--gold);color:var(--gold);}
.pagination button:disabled{opacity:0.5;cursor:not-allowed;}
#page-info{color:var(--muted);font-weight:500;}

/* BACK BUTTON */
.back-section{margin-bottom:40px;}
.back-link{display:inline-flex;align-items:center;gap:8px;color:var(--muted);text-decoration:none;font-size:0.9rem;transition:all 0.2s;}
.back-link:hover{color:var(--gold);}

/* RESPONSIVE */
@media(max-width:768px){
  nav{padding:0 20px;}
  .nav-center{display:none;}
  .container{padding:20px 16px;}
  .section-header h2{font-size:2rem;}
  .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;}
  .filters-section{grid-template-columns:1fr;}
  .history-card{padding:15px;}
}
</style>
</head>
<body>

<!-- NAVBAR -->
<nav>
  <a href="/" class="logo">
    <div class="logo-icon">
      <img src="/logo.png" alt="E&V Prono" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">
    </div>
    E&V<span>Prono</span>
  </a>

  <div class="nav-center">
    <a href="/" class="nav-link">Accueil</a>
    <a href="/" class="nav-link">Stats</a>
    <a href="/history" class="nav-link active">Historique</a>
  </div>

  <div class="nav-right">
    <span class="nav-username" id="nav-username" style="display:none" onclick="window.location.href='/profile'"></span>
    <div id="nav-guest" style="display:flex;gap:8px;">
      <a href="/" class="btn btn-outline">Connexion</a>
      <a href="/" class="btn btn-vip">S'inscrire</a>
    </div>
    <div id="nav-user" style="display:none;gap:8px;align-items:center;">
      <a href="/" class="btn btn-outline" id="btn-portal" style="display:none">‚öôÔ∏è Mon abonnement</a>
      <a href="/logout" class="btn btn-logout">D√©connexion</a>
    </div>
  </div>
</nav>

<!-- BACK SECTION -->
<div class="container">
  <div class="back-section">
    <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
  </div>
</div>

<!-- HISTORIQUE SECTION -->
<div class="container">
  <div class="section-header">
    <h2>üìä Historique des Pronostics</h2>
    <p>Retrouvez tous nos pronostics et leurs r√©sultats d√©taill√©s</p>
  </div>

  <!-- STATISTIQUES D√âTAILL√âES -->
  <div class="stats-grid" id="detailed-stats">
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-info">
        <div class="stat-value" id="success-rate">-</div>
        <div class="stat-label">Taux de r√©ussite</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üéØ</div>
      <div class="stat-info">
        <div class="stat-value" id="total-pronos">-</div>
        <div class="stat-label">Total pronostics</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <div class="stat-value" id="wins">-</div>
        <div class="stat-label">Pronostics gagn√©s</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-info">
        <div class="stat-value" id="losses">-</div>
        <div class="stat-label">Pronostics perdus</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-info">
        <div class="stat-value" id="pending">-</div>
        <div class="stat-label">En attente</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-info">
        <div class="stat-value" id="avg-odds">-</div>
        <div class="stat-label">Cote moyenne</div>
      </div>
    </div>
  </div>

  <!-- FILTRES -->
  <div class="filters-section">
    <div class="filter-group">
      <label>Ligue:</label>
      <select id="filter-league">
        <option value="">Toutes les ligues</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Type:</label>
      <select id="filter-type">
        <option value="">Tous</option>
        <option value="public">Public</option>
        <option value="vip">VIP</option>
      </select>
    </div>
    <div class="filter-group">
      <label>R√©sultat:</label>
      <select id="filter-result">
        <option value="">Tous</option>
        <option value="gagnant">Gagn√©</option>
        <option value="perdant">Perdu</option>
        <option value="pending">En attente</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Date d√©but:</label>
      <input type="date" id="filter-start">
    </div>
    <div class="filter-group">
      <label>Date fin:</label>
      <input type="date" id="filter-end">
    </div>
    <button class="btn btn-vip" onclick="applyFilters()">Appliquer les filtres</button>
    <button class="btn btn-outline" onclick="resetFilters()">R√©initialiser</button>
  </div>

  <!-- LISTE DES PRONOSTICS -->
  <div class="pronos-history" id="pronos-history">
    <div style="text-align:center;padding:40px;">
      <div style="font-size:3rem;margin-bottom:20px;">üìã</div>
      <p style="color:var(--muted);">Chargement de l'historique...</p>
    </div>
  </div>

  <!-- PAGINATION -->
  <div class="pagination" id="pagination">
    <button class="btn btn-outline" onclick="changePage('prev')" id="prev-btn">‚Üê Pr√©c√©dent</button>
    <span id="page-info">Page 1 sur 1</span>
    <button class="btn btn-outline" onclick="changePage('next')" id="next-btn">Suivant ‚Üí</button>
  </div>
</div>

<script>
const API = '';
let TOKEN = localStorage.getItem('token');

function parseJWT(token) {
  try { return JSON.parse(atob(token.split('.')[1])); }
  catch { return null; }
}

// Variables globales pour l'historique
let currentPage = 1;
let currentFilters = {};

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  const user = TOKEN ? parseJWT(TOKEN) : null;
  
  if (user) {
    document.getElementById('nav-guest').style.display = 'none';
    document.getElementById('nav-user').style.display = 'flex';
    document.getElementById('nav-username').style.display = 'inline-block';
    document.getElementById('nav-username').textContent = 'üë§ ' + user.username;
    
    if (user.isVIP || user.isAdmin) {
      document.getElementById('btn-portal').style.display = 'inline-block';
    }
  }
  
  loadHistory();
  loadDetailedStats();
});

// Charger l'historique des pronostics
async function loadHistory(page = 1, filters = {}) {
  try {
    const params = new URLSearchParams({
      page,
      limit: 20,
      ...filters
    });
    
    const res = await fetch(`${API}/api/history?${params}`);
    const data = await res.json();
    
    displayHistory(data.pronos);
    updatePagination(data.pagination);
    
    // Mettre √† jour les filtres disponibles
    if (page === 1) {
      updateLeagueFilter(data.pronos);
    }
  } catch (error) {
    console.error('Erreur chargement historique:', error);
    document.getElementById('pronos-history').innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:20px;">‚ùå</div>
        <p style="color:var(--muted);">Erreur lors du chargement de l'historique</p>
      </div>
    `;
  }
}

// Afficher l'historique
function displayHistory(pronos) {
  const container = document.getElementById('pronos-history');
  
  if (!pronos.length) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:20px;">üìã</div>
        <p style="color:var(--muted);">Aucun prono trouv√© pour ces crit√®res</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = pronos.map(prono => `
    <div class="history-card">
      <div class="history-header">
        <div>
          <div class="history-match">${prono.match}</div>
          <div class="history-league">${prono.league}</div>
        </div>
        <span class="history-result result-${prono.resultat}">
          ${getResultLabel(prono.resultat)}
        </span>
      </div>
      <div class="history-prono">üìä ${prono.prono}</div>
      <div class="history-details">
        <span class="history-odds">üí∞ ${prono.cote}</span>
        <span class="history-date">üìÖ ${new Date(prono.date).toLocaleDateString('fr-FR')}</span>
        <span class="history-type">${prono.type === 'vip' ? '‚≠ê VIP' : 'üåç Public'}</span>
      </div>
      ${prono.analyse ? `<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);color:var(--muted);font-size:0.85rem;">${prono.analyse}</div>` : ''}
    </div>
  `).join('');
}

// Obtenir le libell√© du r√©sultat
function getResultLabel(resultat) {
  switch (resultat) {
    case 'gagnant': return '‚úÖ Gagn√©';
    case 'perdant': return '‚ùå Perdu';
    case 'pending': return '‚è≥ En attente';
    default: return resultat;
  }
}

// Mettre √† jour la pagination
function updatePagination(pagination) {
  document.getElementById('page-info').textContent = `Page ${pagination.page} sur ${pagination.pages}`;
  document.getElementById('prev-btn').disabled = pagination.page === 1;
  document.getElementById('next-btn').disabled = pagination.page === pagination.pages;
  currentPage = pagination.page;
}

// Changer de page
function changePage(direction) {
  const newPage = direction === 'prev' ? currentPage - 1 : currentPage + 1;
  loadHistory(newPage, currentFilters);
}

// Appliquer les filtres
function applyFilters() {
  const filters = {
    league: document.getElementById('filter-league').value,
    type: document.getElementById('filter-type').value,
    resultat: document.getElementById('filter-result').value,
    startDate: document.getElementById('filter-start').value,
    endDate: document.getElementById('filter-end').value
  };
  
  // Supprimer les filtres vides
  Object.keys(filters).forEach(key => {
    if (!filters[key]) delete filters[key];
  });
  
  currentFilters = filters;
  currentPage = 1;
  loadHistory(1, filters);
}

// R√©initialiser les filtres
function resetFilters() {
  document.getElementById('filter-league').value = '';
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-result').value = '';
  document.getElementById('filter-start').value = '';
  document.getElementById('filter-end').value = '';
  
  currentFilters = {};
  currentPage = 1;
  loadHistory(1, {});
}

// Mettre √† jour le filtre des ligues
function updateLeagueFilter(pronos) {
  const leagues = [...new Set(pronos.map(p => p.league).filter(Boolean))];
  const select = document.getElementById('filter-league');
  
  select.innerHTML = '<option value="">Toutes les ligues</option>' +
    leagues.map(league => `<option value="${league}">${league}</option>`).join('');
}

// Charger les statistiques d√©taill√©es
async function loadDetailedStats() {
  try {
    const res = await fetch(`${API}/api/history/stats`);
    const stats = await res.json();
    
    document.getElementById('success-rate').textContent = stats.tauxReussite + '%';
    document.getElementById('total-pronos').textContent = stats.total;
    document.getElementById('wins').textContent = stats.gagnants;
    document.getElementById('losses').textContent = stats.perdants;
    document.getElementById('pending').textContent = stats.enAttente;
    document.getElementById('avg-odds').textContent = stats.coteMoyenne;
  } catch (error) {
    console.error('Erreur stats d√©taill√©es:', error);
  }
}
</script>

</body>
</html>
